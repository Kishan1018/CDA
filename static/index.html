  <script>
    let sessionId = crypto.randomUUID();
    window.supportChoice = undefined;
    window.choiceMode = true;
    const originalInputHTML = document.getElementById('textInputContainer').innerHTML;
    
    const userInput = document.getElementById('userInput');
    let initialHeight = userInput.scrollHeight;
    userInput.style.height = initialHeight + "px";
    
    userInput.addEventListener('input', function() {
      this.style.height = "auto";
      this.style.height = this.scrollHeight + "px";
    });
    
    async function sendMessage() {
      const textArea = document.getElementById('userInput');
      const userMessage = textArea.value.trim();
      if (!userMessage) return;
      
      const messagesDiv = document.getElementById('messages');
      const userMsgDiv = document.createElement('div');
      userMsgDiv.className = 'message user-message';
      userMsgDiv.innerText = userMessage;
      messagesDiv.appendChild(userMsgDiv);
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
      
      textArea.value = "";
      textArea.style.height = initialHeight + "px";
      
      const spinnerBubble = document.createElement('div');
      spinnerBubble.className = 'message response-message';
      const spinnerContainer = document.createElement('div');
      spinnerContainer.className = 'spinner-container';
      spinnerContainer.innerHTML = '<div class="typing-indicator"><span></span><span></span><span></span></div>';
      spinnerBubble.appendChild(spinnerContainer);
      messagesDiv.appendChild(spinnerBubble);
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
      
      try {
        const payload = { message: userMessage, session_id: sessionId };
        if (window.supportChoice) {
          payload.support_choice = window.supportChoice;
        }
        const response = await fetch('/chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        const data = await response.json();
        
        messagesDiv.removeChild(spinnerBubble);
        
        const responseBubble = document.createElement('div');
        responseBubble.className = 'message response-message';
        responseBubble.innerHTML = data.reply;
        messagesDiv.appendChild(responseBubble);
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
      } catch (error) {
        console.error('Error communicating with the backend:', error);
        if (spinnerBubble.parentNode) {
          messagesDiv.removeChild(spinnerBubble);
        }
      }
    }
    
    function toggleTheme() {
      document.body.classList.toggle('light-mode');
      document.body.classList.toggle('dark-mode');
    }
    
    function initializeChoiceMode() {
      const inputSection = document.getElementById('inputSection');
      inputSection.innerHTML = '';
      const choiceContainer = document.createElement('div');
      choiceContainer.classList.add('choice-mode');
      choiceContainer.style.display = 'flex';
      choiceContainer.style.justifyContent = 'center';
      choiceContainer.style.width = '100%';
      choiceContainer.style.gap = '2%';
      
      const mobileButton = document.createElement('button');
      mobileButton.classList.add('choice-input-button');
      mobileButton.innerText = 'CHAMPS Mobile App';
      
      const desktopButton = document.createElement('button');
      desktopButton.classList.add('choice-input-button');
      desktopButton.innerText = 'CHAMPS CMMS';
      
      mobileButton.addEventListener('click', function() {
        handleProductChoice('mobile');
      });
      desktopButton.addEventListener('click', function() {
        handleProductChoice('desktop');
      });
      
      choiceContainer.appendChild(mobileButton);
      choiceContainer.appendChild(desktopButton);
      inputSection.appendChild(choiceContainer);
    }
    
    function handleProductChoice(product) {
      window.supportChoice = product;
      window.choiceMode = false;
      const promptBubble = document.getElementById('promptBubble');
      if (promptBubble) promptBubble.remove();
      const messageText = product === 'mobile'
        ? "How can I help you with CHAMPS Mobile App?"
        : "How can I help you with CHAMPS CMMS?";
      const messagesDiv = document.getElementById('messages');
      const botMsgBubble = document.createElement('div');
      botMsgBubble.className = 'message response-message';
      botMsgBubble.innerText = messageText;
      messagesDiv.appendChild(botMsgBubble);
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
      
      const inputSection = document.getElementById('inputSection');
      const choiceContainer = inputSection.querySelector('.choice-mode');
      if (choiceContainer) {
        choiceContainer.style.transition = 'opacity 0.5s ease';
        choiceContainer.style.opacity = '0';
        setTimeout(() => {
          inputSection.innerHTML = originalInputHTML;
          const newInputContainer = document.getElementById('textInputContainer');
          newInputContainer.style.opacity = 0;
          setTimeout(() => {
            newInputContainer.style.transition = 'opacity 0.5s ease';
            newInputContainer.style.opacity = '1';
          }, 10);
          const restoredUserInput = document.getElementById('userInput');
          initialHeight = restoredUserInput.scrollHeight;
          restoredUserInput.style.height = initialHeight + "px";
          restoredUserInput.addEventListener('input', function() {
            this.style.height = "auto";
            this.style.height = this.scrollHeight + "px";
          });
        }, 500);
      } else {
        inputSection.innerHTML = originalInputHTML;
      }
    }
    
    function initializeChat() {
      const messagesDiv = document.getElementById('messages');
      
      const welcomeBubble = document.createElement('div');
      welcomeBubble.className = 'message response-message';
      welcomeBubble.innerText = 'Welcome to CHAMPS Software!';
      messagesDiv.appendChild(welcomeBubble);
      
      const promptBubble = document.createElement('div');
      promptBubble.className = 'message response-message';
      promptBubble.id = "promptBubble";
      promptBubble.innerText = 'Please choose a product below.';
      messagesDiv.appendChild(promptBubble);
      
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
      initializeChoiceMode();
    }
    
    document.addEventListener('DOMContentLoaded', function() {
      initializeChat();
    });
    
    window.addEventListener('beforeunload', function() {
      navigator.sendBeacon('/end_session', JSON.stringify({ session_id: sessionId }));
    });
  </script>
